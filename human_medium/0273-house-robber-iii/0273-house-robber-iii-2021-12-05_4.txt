from collections import defaultdict

class Solution:
    def rob(self, root: Optional[TreeNode]) -> int:
        def rec(node, depth):
            if not node:
                return
            layer_dict[depth].append(node)
            rec(node.left, depth + 1)
            rec(node.right, depth + 1)
            
        #get layer dict
        layer_dict = defaultdict(list)
        rec(root, 0)
        
        #dp
        dp_use, dp_no_use = {None : 0}, {None : 0}
        
        for layer in range(max(layer_dict.keys()), -1, -1):
            for u in layer_dict[layer]:
                dp_use[u] = dp_no_use[u.left] + dp_no_use[u.right] + u.val
                dp_no_use[u] = max(dp_use[u.left], dp_no_use[u.left]) + max(dp_use[u.right], dp_no_use[u.right])
        
        return max(dp_use[root], dp_no_use[root])