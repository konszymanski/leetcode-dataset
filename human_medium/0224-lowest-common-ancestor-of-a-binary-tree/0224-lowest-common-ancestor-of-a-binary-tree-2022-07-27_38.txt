def lowestCommonAncestor(self, root: \'TreeNode\', p: \'TreeNode\', q: \'TreeNode\') -> \'TreeNode\':
    ans = (math.inf, 0, None)
    between = depth = 0
    while root:
        if root.left:
            rmost = root.left
            prev_depth = 1

            while rmost.right and rmost.right != root:
                rmost = rmost.right
                prev_depth += 1

            if not rmost.right:
                rmost.right = root
                root = root.left
                depth += 1
                continue

            rmost.right = None
            depth -= prev_depth + 1

        between ^= root in (p, q)
        if between or root in (p, q):
            ans = min(ans, (depth, root.val, root))

        root = root.right
        depth += 1

    return ans[2]