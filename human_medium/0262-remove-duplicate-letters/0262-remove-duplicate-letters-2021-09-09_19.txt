from collections import defaultdict
class Solution:
    def removeDuplicateLetters(self, s: str) -> str:
        # find the index of last occurence for each letter
        # in O(n) time. We will use this to decide whether
        # we can discard a letter when a lexicographically
        # smaller letter is encountered in the future
        letter2lastIdx = defaultdict(int)
        for i in range(len(s)):
            letter2lastIdx[s[i]] = i
            
        # we maintain a monotonic stack, elements in which satisfies
        # the following properties:
        # 1. the letters are lexicographically sorted in chunks
        # 2. chunks form because sometimes we cannot pop a larger letter out because
        #     otherwise we\'ll never see this letter in the future.
        mono_stack = []
        mono_stack_set = set()
        for i in range(len(s)):
            if s[i] not in mono_stack_set:
                while mono_stack and s[i] < mono_stack[-1] and i < letter2lastIdx[mono_stack[-1]]:
                    mono_stack_set.remove(mono_stack.pop())
                mono_stack.append(s[i])
                mono_stack_set.add(s[i])
        return "".join(mono_stack)