from collections import defaultdict, deque

class Solution:
    def calcEquation(self, equations: List[List[str]], values: List[float], queries: List[List[str]]) -> List[float]:
        # adjacency matrix  {x: [(y1, w1), (y2, w2)]}
        g = defaultdict(list)
        for eq, val in zip(equations, values):
            x, y = eq[0], eq[1]
            g[x].append((y, val))
            g[y].append((x, 1 / val))
        
        # query result cache
        cache = {}

        def compute_path_product(x, y):
            if len(g[x]) == 0:
                return -1 
            q = deque([(x, 1)])
            visited_nodes = set([x])
            while len(q) > 0:
                node, prod = q.popleft()
                if node == y:
                    return prod
                for z, weight in g[node]:
                    if z not in visited_nodes:
                        q.append((z, prod * weight))
                        visited_nodes.add(z)
            return -1

        # for each query, find path using BFS & compute path product
        outputs = []
        for query in queries:
            if tuple(query) in cache:
                outputs.append(cache[tuple(query)])
            else:
                res = compute_path_product(query[0], query[1])
                cache[tuple(query)] = res 
                outputs.append(res)
        
        return outputs