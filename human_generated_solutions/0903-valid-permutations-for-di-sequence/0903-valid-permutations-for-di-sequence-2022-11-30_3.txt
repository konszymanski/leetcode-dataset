from functools import lru_cache
class Solution:
    def numPermsDISequence(self, s):
        return self.backtrack(s) % (10**9 + 7)

    def backtrack(self, s):  # with pruning and memo
        L = len(s)
        nums = set(range(-1, L + 1))  # dummy -1 as \'pre\', only happens when idx == 0 (in which case we don\'t need var \'pre\')

        @lru_cache(None)
        def backtrack(idx, pre):  # current index
            nums.remove(pre)

            cnt = 0
            if not nums:            cnt = 1  # empty, it\'s a valid permutation
            elif idx == 0:          cnt = sum(backtrack(idx + 1, num) for num in range(L + 1))
            elif s[idx - 1] == \'D\': cnt = sum(backtrack(idx + 1, num) for num in range(pre) if num in nums)
            elif s[idx - 1] == \'I\': cnt = sum(backtrack(idx + 1, num) for num in range(pre + 1, L + 1) if num in nums)

            nums.add(pre)  # recover
            return cnt

        return backtrack(0, -1)