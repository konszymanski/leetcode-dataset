class Solution:
    def maximumInvitations(self, favorite: List[int]) -> int:
        
        N = len(favorite)
        people = 0
        adj_list = defaultdict(list)
        indegree = defaultdict(list)
        bond = set()
        
        for a, b in enumerate(favorite):
            adj_list[a].append(b)
            indegree[b].append(a)
            if favorite[b] == a:
                bond.add(tuple(sorted([a, b])))
        
        # 1 case, 
        # find total number of bonding of 2 people and a tail for each of this person
        def find(node, seen):
            total = 0
            for nei in indegree[node]:
                if nei not in seen:
                    seen.add(nei)
                    total = max(total, find(nei, seen) + 1)
            return total
        
        for a, b in bond:
            seen = {a, b}
            people += 2 + find(a, seen) + find(b, seen)
        
        
        # 2 case, Tarjan\'s algorithm
        # find max number of nodes in a Strongly Connected Component (SCC)
        def dfs(curr):
            nonlocal i, scc_max
            stack.append(curr)
            on_stack[curr] = 1
            i += 1
            ids[curr] = low[curr] = i
            
            for nei in adj_list[curr]:
                if ids[nei] == -1:
                    dfs(nei)
                if on_stack[nei]:
                    low[curr] = min(low[curr], low[nei])
            
            if ids[curr] == low[curr]:
                scc_length = 0
                while stack:
                    scc_length += 1
                    node = stack.pop()
                    on_stack[node] = 0
                    low[node] = ids[curr]
                    if node == curr:
                        break
                if scc_length > 2:
                    scc_max = max(scc_max, scc_length)
        scc_max = 0
        i = 0
        on_stack = [0] * N
        stack = []
        ids = [-1] * N
        low = [0] * N
        
        for i in range(N):
            if ids[i] == -1:
                dfs(i)
        
        return max(people, scc_max)