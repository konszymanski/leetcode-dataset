import sortedcontainers
class Solution:
    def maxSumSubmatrix(self, matrix: List[List[int]], k: int) -> int:
        def updateResult(nums, k):
            nonlocal result
            
            summ = 0
            sortedSum = sortedcontainers.SortedSet()
            sortedSum.add(0)
            
            for num in nums:
                summ += num
                x = sortedSum.bisect_left(summ - k)
                if x < len(sortedSum):
                    result = max(result, summ - sortedSum[x])
                    
                sortedSum.add(summ)
                    
        result = -math.inf
                    
        for i in range(len(matrix)):
            rowSum = [0] * len(matrix[0])
            
            for row in range(i, len(matrix)):
                for col in range(len(matrix[row])):
                    rowSum[col] += matrix[row][col]
                    
                updateResult(rowSum, k)
                
                if result == k:
                    return result
                
        return result if result != -math.inf else -1