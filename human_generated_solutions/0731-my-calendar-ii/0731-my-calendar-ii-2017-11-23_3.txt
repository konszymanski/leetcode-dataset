class MyCalendarTwo(object):

    def __init__(self):
        self.one = []  # intervals that are booked at least once
        self.two = []  # intervals that are booked twice
        
    def is_valid(self, start, end):
        """
        check if it is valid to insert into self.two
        return -1 or the index of the insertion place
        """
        if end <= start:
            return -1
        
        i = bisect.bisect_right(self.two, start)
        if i % 2:
            return -1
        
        j = bisect.bisect_left(self.two, end)
        if i != j:
            return -1
        
        return i
    
    def book(self, start, end):
        """
        :type start: int
        :type end: int
        :rtype: bool
        """
        t = self.is_valid(start, end)  
        if t == -1:
            return False
        # t will be the insertion position in self.two

        i = bisect.bisect_right(self.one, start)
        j = bisect.bisect_left(self.one, end)
        
        if i % 2: 
            if j % 2:  # when both start and end is inside some intervals in self.one
                self.two[t:t] = [start] + self.one[i:j] + [end]
                self.one[i:j] = []
            else:      # when start is and end is not
                self.two[t:t] = [start] + self.one[i:j]
                self.one[i:j] = [end]
        else:
            if j % 2:  # when start is not and end is
                self.two[t:t] = self.one[i:j] + [end]
                self.one[i:j] = [start]
            else:      # when neither start nor end is
                self.two[t:t] = self.one[i:j]
                self.one[i:j] = [start, end]
                
        return True