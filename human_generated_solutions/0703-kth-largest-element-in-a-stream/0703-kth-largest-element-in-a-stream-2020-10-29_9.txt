class myTreeNode {
public:
    myTreeNode(int x) : val(x), cnt(1), left(nullptr), right(nullptr) {}

    int val;
    int cnt; // counts for the nodes in subtree (double-counts duplicates)
    myTreeNode *left, *right;
};


class KthLargest {
public:
    KthLargest(int k, vector<int>& nums) {
        this->k = k;
        for(int i=0;i<nums.size();++i)
            root = insert(root, nums[i]);
    }

    int add(int val) {
        root = insert(root, val);
        return search(root, this->k);
    }

private:
    int k;
    myTreeNode* root = nullptr;

    myTreeNode* insert(myTreeNode* node, int val) {
        if(!node) return new myTreeNode(val);
        if(val < node->val)      node->left = insert(node->left, val);
        else if(val > node->val) node->right = insert(node->right, val);
        ++node->cnt;
        return node;
    }

    int search(myTreeNode* node, int k) {
        int Rcnt = node->right ? node->right->cnt : 0;
        int Lcnt = node->left ? node->left->cnt : 0;
        if(node->cnt-Lcnt >= k && k > Rcnt) return node->val;
        else if(Rcnt >= k) return search(node->right, k);
        else               return search(node->left, k - (node->cnt - Lcnt));
    }
};